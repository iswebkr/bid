<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="BidColctHistMapper">
	<sql id="insertBidColctHistQuery">
		-- 수집이력관리 등록
		INSERT INTO tb_colct_hist (
				colct_id -- 수집대상아이디
				, colct_uri -- 수집대상URL
				, colct_desc -- 수집내용
				, colct_bgn_dt -- 수집시작일자
				, colct_end_dt -- 수집종료일자
				, colct_tot_page -- 수집대상페이지수
				, colct_cmpl_page -- 수집완료페이지수
				, colct_tot_cnt -- 수집대상카운트수
				, colct_cmpl_cnt -- 수집완료카운트수
				, created_dt -- 생성일시 (시스템 등록일시)
				, created_by -- 생성자 (시스템 등록자)
				, updated_dt -- 수정일시 (시스템 수정일시)
				, updated_by -- 수정자 (시스템 수정자)
		) VALUES (
				#{colctId} -- 수집대상아이디
				, #{colctUri} -- 수집대상URL
				, #{colctDesc} -- 수집내용
				, #{colctBgnDt} -- 수집시작일자
				, #{colctEndDt} -- 수집종료일자
				, #{colctTotPage} -- 수집대상페이지수
				, #{colctCmplPage} -- 수집완료페이지수
				, #{colctTotCnt} -- 수집대상카운트수
				, #{colctCmplCnt} -- 수집완료카운트수
				, CURRENT_TIMESTAMP -- 생성일시 (시스템 등록일시)
				, #{createdBy} -- 생성자 (시스템 등록자)
				, CURRENT_TIMESTAMP -- 수정일시 (시스템 수정일시)
				, #{updatedBy} -- 수정자 (시스템 수정자)
		)
	</sql>

	<select id="selectColctHistResultByDate" parameterType="kr.co.peopleinsoft.cmmn.dto.BidColctHistDto" resultType="kr.co.peopleinsoft.cmmn.dto.BidColctHistResultDto">
		select
				colct_id
				, colct_bgn_dt
				, colct_end_dt
				, max(colct_tot_page) max_tot_page
				, count(distinct colct_cmpl_page) cmpl_colct_page
				, max(colct_tot_cnt) max_total_cnt
				, sum(colct_cmpl_cnt) sum_cmpl_cnt
		, case
				when max(colct_tot_cnt) = sum(colct_cmpl_cnt)
				and min(colct_cmpl_page) = 1
				and max(colct_tot_page) = count(distinct colct_cmpl_page)
				then 'complete'
		end colct_state
		, max(colct_tot_cnt) - sum(colct_cmpl_cnt) as diff_count
		, max(colct_tot_page) - count(distinct colct_cmpl_page) as diff_page
		from 	tb_colct_hist
		where 	colct_id = #{colctId}
		<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(colctBgnDt)">
			and 	colct_bgn_dt = #{colctBgnDt}
		</if>
		<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(colctEndDt)">
			and 	colct_end_dt = #{colctEndDt}
		</if>
		group by colct_id, colct_bgn_dt, colct_end_dt
	</select>

	<insert id="batchInsertColctHist" parameterType="kr.co.peopleinsoft.cmmn.dto.BidColctHistDto">
		<include refid="insertBidColctHistQuery" />
	</insert>

	<update id="updateColctPageInfo" parameterType="kr.co.peopleinsoft.cmmn.dto.BidColctHistDto">
		-- 수집이력관리 수정
		UPDATE tb_colct_hist
		SET
				colct_tot_page = #{colctTotPage} -- 수집대상페이지수
				,   colct_tot_cnt = #{colctTotCnt} -- 수집대상카운트수
				,   updated_dt = CURRENT_TIMESTAMP -- 수정일시 (시스템 수정일시)
		where 	colct_id = #{colctId} -- 수집대상아이디
		and 	colct_bgn_dt = #{colctBgnDt} -- 수집시작일자
		and 	colct_end_dt = #{colctEndDt} -- 수집종료일자
	</update>
</mapper>